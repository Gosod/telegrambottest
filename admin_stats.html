<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –ê–¥–º–∏–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle {
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .tab {
            padding: 10px 20px;
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 10px;
            background: transparent;
            color: var(--tg-theme-button-color, #0088cc);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #0088cc);
            color: #fff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        .stats-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stats-title {
            font-weight: 600;
            font-size: 16px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #0088cc);
        }

        .employee-card {
            background: var(--tg-theme-bg-color, #fff);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .employee-name {
            font-weight: 600;
            font-size: 16px;
        }

        .employee-hours {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #0088cc);
        }

        .employee-projects {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 8px;
        }

        .project-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .chart-container {
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            height: 250px;
        }

        .report-item {
            background: var(--tg-theme-bg-color, #fff);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .report-date {
            color: var(--tg-theme-hint-color, #999);
            font-size: 12px;
        }

        .report-details {
            color: var(--tg-theme-hint-color, #666);
            font-size: 13px;
            margin-top: 4px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: var(--tg-theme-button-color, #0088cc);
            color: #fff;
            border-color: var(--tg-theme-button-color, #0088cc);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
        <div class="subtitle">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>

        <!-- –¢–∞–±—ã -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">–û–±–∑–æ—Ä</button>
            <button class="tab" data-tab="employees">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
            <button class="tab" data-tab="projects">–ü—Ä–æ–µ–∫—Ç—ã</button>
            <button class="tab" data-tab="reports">–û—Ç—á—ë—Ç—ã</button>
        </div>

        <!-- –û–±–∑–æ—Ä -->
        <div class="tab-content active" id="overview">
            <div class="stats-card">
                <div class="stats-header">
                    <span class="stats-title">‚è±Ô∏è –í—Å–µ–≥–æ —á–∞—Å–æ–≤</span>
                    <span class="stats-value" id="totalHours">0</span>
                </div>
            </div>

            <div class="stats-card">
                <div class="stats-header">
                    <span class="stats-title">üìù –í—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤</span>
                    <span class="stats-value" id="totalReports">0</span>
                </div>
            </div>

            <div class="stats-card">
                <div class="stats-header">
                    <span class="stats-title">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    <span class="stats-value" id="totalEmployees">0</span>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="overviewChart"></canvas>
            </div>
        </div>

        <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -->
        <div class="tab-content" id="employees">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter="week">–ù–µ–¥–µ–ª—è</button>
                <button class="filter-btn" data-filter="month">–ú–µ—Å—è—Ü</button>
            </div>
            <div id="employeesList"></div>
        </div>

        <!-- –ü—Ä–æ–µ–∫—Ç—ã -->
        <div class="tab-content" id="projects">
            <div id="projectsList"></div>
            <div class="chart-container">
                <canvas id="projectsChart"></canvas>
            </div>
        </div>

        <!-- –û—Ç—á—ë—Ç—ã -->
        <div class="tab-content" id="reports">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter-reports="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter-reports="today">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="filter-btn" data-filter-reports="week">–ù–µ–¥–µ–ª—è</button>
            </div>
            <div id="reportsList"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–æ—Ç–∞ (–ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ initData –∏–ª–∏ query params)
        // –î–ª—è –¥–µ–º–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        let statsData = null;

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        
        if (dataParam) {
            try {
                statsData = JSON.parse(decodeURIComponent(dataParam));
            } catch (e) {
                console.error('Error parsing data:', e);
            }
        }

        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º demo –¥–∞–Ω–Ω—ã–µ
        if (!statsData) {
            statsData = {
                total_hours: 248,
                total_reports: 42,
                employees: [
                    {
                        name: "–ò–≤–∞–Ω",
                        hours: 120,
                        reports: 18,
                        projects: {"–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞": 80, "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ": 40}
                    },
                    {
                        name: "–ú–∞—Ä–∏—è",
                        hours: 96,
                        reports: 16,
                        projects: {"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥": 60, "–î–∏–∑–∞–π–Ω": 36}
                    },
                    {
                        name: "–ü—ë—Ç—Ä",
                        hours: 32,
                        reports: 8,
                        projects: {"–ü–æ–¥–¥–µ—Ä–∂–∫–∞": 32}
                    }
                ],
                projects: {
                    "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞": 80,
                    "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥": 60,
                    "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ": 40,
                    "–î–∏–∑–∞–π–Ω": 36,
                    "–ü–æ–¥–¥–µ—Ä–∂–∫–∞": 32
                },
                recent_reports: [
                    {
                        date: "2026-02-13",
                        time: "14:30",
                        employee: "–ò–≤–∞–Ω",
                        project: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞",
                        hours: 6,
                        comment: "–†–∞–±–æ—Ç–∞–ª –Ω–∞–¥ API"
                    },
                    {
                        date: "2026-02-13",
                        time: "12:15",
                        employee: "–ú–∞—Ä–∏—è",
                        project: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
                        hours: 4,
                        comment: "–°–æ—Ü—Å–µ—Ç–∏"
                    }
                ]
            };
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–∑–æ—Ä–∞
        function renderOverview() {
            document.getElementById('totalHours').textContent = statsData.total_hours;
            document.getElementById('totalReports').textContent = statsData.total_reports;
            document.getElementById('totalEmployees').textContent = statsData.employees.length;

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
            const ctx = document.getElementById('overviewChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: statsData.employees.map(e => e.name),
                    datasets: [{
                        label: '–ß–∞—Å—ã',
                        data: statsData.employees.map(e => e.hours),
                        backgroundColor: 'rgba(0, 136, 204, 0.6)',
                        borderColor: 'rgba(0, 136, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        function renderEmployees() {
            const container = document.getElementById('employeesList');
            container.innerHTML = '';

            statsData.employees
                .sort((a, b) => b.hours - a.hours)
                .forEach(emp => {
                    const card = document.createElement('div');
                    card.className = 'employee-card';
                    
                    let projectsHtml = '';
                    for (const [project, hours] of Object.entries(emp.projects)) {
                        projectsHtml += `
                            <div class="project-item">
                                <span>${project}</span>
                                <span>${hours} —á</span>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div class="employee-header">
                            <span class="employee-name">üë§ ${emp.name}</span>
                            <span class="employee-hours">${emp.hours} —á</span>
                        </div>
                        <div class="employee-projects">
                            üìù –û—Ç—á—ë—Ç–æ–≤: ${emp.reports}
                        </div>
                        ${projectsHtml}
                    `;
                    
                    container.appendChild(card);
                });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤
        function renderProjects() {
            const container = document.getElementById('projectsList');
            container.innerHTML = '';

            const sorted = Object.entries(statsData.projects).sort((a, b) => b[1] - a[1]);

            sorted.forEach(([project, hours]) => {
                const card = document.createElement('div');
                card.className = 'stats-card';
                card.innerHTML = `
                    <div class="stats-header">
                        <span class="stats-title">üìÅ ${project}</span>
                        <span class="stats-value">${hours} —á</span>
                    </div>
                `;
                container.appendChild(card);
            });

            // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
            const ctx = document.getElementById('projectsChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(([name]) => name),
                    datasets: [{
                        data: sorted.map(([, hours]) => hours),
                        backgroundColor: [
                            'rgba(0, 136, 204, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(244, 67, 54, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤
        function renderReports() {
            const container = document.getElementById('reportsList');
            container.innerHTML = '';

            if (!statsData.recent_reports || statsData.recent_reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</div>
                    </div>
                `;
                return;
            }

            statsData.recent_reports.forEach(report => {
                const item = document.createElement('div');
                item.className = 'report-item';
                item.innerHTML = `
                    <div class="report-header">
                        <span>üë§ ${report.employee}</span>
                        <span class="report-date">${report.date} ${report.time}</span>
                    </div>
                    <div>üìÅ ${report.project} - ${report.hours}—á</div>
                    <div class="report-details">üí¨ ${report.comment}</div>
                `;
                container.appendChild(item);
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // –î–æ–±–∞–≤–ª—è–µ–º active
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName).classList.add('active');

                // –í–∏–±—Ä–∞—Ü–∏—è
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderOverview();
        renderEmployees();
        renderProjects();
        renderReports();

        console.log('Admin stats loaded');
    </script>
</body>
</html>
