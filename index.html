<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap');

:root {
  --accent: var(--tg-theme-button-color, #2563eb);
  --accent-light: color-mix(in srgb, var(--accent) 12%, transparent);
  --bg: var(--tg-theme-bg-color, #f8fafc);
  --bg2: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #0f172a);
  --hint: var(--tg-theme-hint-color, #94a3b8);
  --border: color-mix(in srgb, var(--hint) 25%, transparent);
  --danger: #ef4444;
  --success: #22c55e;
  --radius: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Golos Text', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 24px;
}

/* NAV */
.nav {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  display: flex; gap: 6px;
  overflow-x: auto;
  scrollbar-width: none;
}
.nav::-webkit-scrollbar { display: none; }
.nav-btn {
  padding: 7px 14px;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  background: transparent;
  color: var(--hint);
  font: 500 13px 'Golos Text', sans-serif;
  cursor: pointer;
  white-space: nowrap;
  transition: all .2s;
  flex-shrink: 0;
}
.nav-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* PAGES */
.page { display: none; padding: 16px; animation: up .25s ease; }
.page.active { display: block; }
@keyframes up { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* HEADINGS */
.page-title {
  font-size: 22px; font-weight: 700;
  margin-bottom: 4px; letter-spacing: -.3px;
}
.page-sub { font-size: 14px; color: var(--hint); margin-bottom: 20px; }

/* CARDS */
.card {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}
.card-row {
  display: flex; justify-content: space-between; align-items: center;
}
.card-label { font-size: 14px; color: var(--hint); }
.card-value { font-size: 22px; font-weight: 700; color: var(--accent); }

/* MENU GRID */
.menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 4px; }
.menu-card {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 20px 16px;
  text-align: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform .15s, box-shadow .15s;
  border: 1.5px solid transparent;
  user-select: none;
}
.menu-card:active { transform: scale(.96); box-shadow: none; }
.menu-card:hover { border-color: var(--accent); }
.menu-icon { font-size: 32px; margin-bottom: 10px; }
.menu-title { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
.menu-desc { font-size: 12px; color: var(--hint); }

/* FORM */
.form-label {
  font-weight: 600; font-size: 14px;
  margin-bottom: 10px; display: block;
  color: var(--text);
}
.form-group { margin-bottom: 22px; }

/* PROJECT CARDS */
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; }
.proj-card {
  padding: 16px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  text-align: center;
  transition: all .2s;
  background: var(--bg2);
  user-select: none;
}
.proj-card:active { transform: scale(.95); }
.proj-card.selected {
  border-color: var(--accent);
  background: var(--accent);
  color: #fff;
}
.proj-abbr { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.proj-name { font-size: 11px; opacity: .8; line-height: 1.3; }

/* DASHED ADD BTN */
.dashed-btn {
  width: 100%; padding: 12px;
  border: 2px dashed var(--accent);
  border-radius: var(--radius);
  background: var(--accent-light);
  color: var(--accent);
  font: 600 14px 'Golos Text', sans-serif;
  cursor: pointer; margin-top: 10px;
  transition: opacity .2s;
}
.dashed-btn:active { opacity: .7; }

/* HOURS */
.hours-box {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 14px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: var(--shadow);
}
.hours-big { font-size: 40px; font-weight: 700; color: var(--accent); line-height: 1; }
.hours-unit { font-size: 14px; color: var(--hint); margin-top: 4px; }

input[type="range"] {
  width: 100%; height: 6px;
  border-radius: 3px;
  background: var(--border);
  outline: none;
  -webkit-appearance: none;
  padding: 0; margin-bottom: 12px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 26px; height: 26px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}
input[type="range"]::-moz-range-thumb {
  width: 26px; height: 26px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
}

.quick-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.quick-btn {
  padding: 11px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--bg2);
  color: var(--text);
  font: 600 15px 'Golos Text', sans-serif;
  cursor: pointer; transition: all .2s;
}
.quick-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}
.quick-btn:active { transform: scale(.95); }

/* TEXTAREA */
textarea, input[type="text"] {
  width: 100%; padding: 13px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  font: 15px 'Golos Text', sans-serif;
  background: var(--bg2); color: var(--text);
  resize: vertical; transition: border-color .2s;
}
textarea { min-height: 90px; }
textarea:focus, input:focus {
  outline: none; border-color: var(--accent);
}

.input-hint { font-size: 12px; color: var(--hint); margin-top: 6px; }

/* SUMMARY */
.summary {
  background: var(--accent-light);
  border: 1.5px solid var(--accent);
  border-radius: var(--radius);
  padding: 14px;
  margin-top: 16px;
}
.summary-title { font-weight: 700; font-size: 14px; margin-bottom: 10px; }
.summary-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.summary-row:last-child { border: none; }
.summary-key { color: var(--hint); }
.summary-val { font-weight: 600; max-width: 60%; text-align: right; }

/* MULTI-PROJECT LIST */
.project-list-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px;
  background: var(--bg2);
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  font-size: 14px;
}
.proj-list-name { font-weight: 600; }
.proj-list-hours { color: var(--accent); font-weight: 700; }
.remove-btn {
  background: none; border: none;
  color: var(--danger); font-size: 18px;
  cursor: pointer; padding: 0 4px;
}

/* BUTTONS */
.btn {
  width: 100%; padding: 15px;
  border: none; border-radius: var(--radius);
  font: 600 15px 'Golos Text', sans-serif;
  cursor: pointer; margin-top: 10px;
  transition: opacity .2s, transform .15s;
}
.btn:active { transform: scale(.98); opacity: .9; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-secondary {
  background: transparent;
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
.btn-danger {
  background: transparent;
  color: var(--danger);
  border: 1.5px solid var(--danger);
}

/* ERROR */
.error-msg { font-size: 13px; color: var(--danger); margin-top: 6px; display: none; }
.error-msg.show { display: block; }

/* INFO */
.info-card {
  background: var(--accent-light);
  border-left: 4px solid var(--accent);
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  margin-bottom: 16px;
  line-height: 1.5;
}

/* STAT TABS */
.stat-tabs { display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto; }
.stat-tab {
  padding: 7px 14px; border-radius: 20px;
  border: 1.5px solid var(--border);
  background: transparent; color: var(--hint);
  font: 500 13px 'Golos Text', sans-serif;
  cursor: pointer; white-space: nowrap;
  flex-shrink: 0; transition: all .2s;
}
.stat-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* EMPLOYEE CARD */
.emp-card {
  background: var(--bg2); border-radius: var(--radius);
  padding: 14px; margin-bottom: 10px;
  box-shadow: var(--shadow);
}
.emp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.emp-name { font-weight: 700; font-size: 15px; }
.emp-hours { font-size: 20px; font-weight: 700; color: var(--accent); }
.emp-proj { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
.emp-proj:last-child { border: none; }
.emp-proj-name { color: var(--hint); }

/* REPORT ITEM */
.report-item {
  background: var(--bg2); border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  box-shadow: var(--shadow); font-size: 13px;
}
.report-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
.report-emp { font-weight: 700; }
.report-date { color: var(--hint); font-size: 12px; }
.report-proj { color: var(--accent); font-weight: 600; }
.report-comment { color: var(--hint); margin-top: 4px; font-style: italic; }

/* CHART */
.chart-wrap {
  background: var(--bg2); border-radius: var(--radius);
  padding: 14px; margin-bottom: 12px;
  box-shadow: var(--shadow); height: 220px;
}

/* ASSIGN */
.user-select {
  width: 100%; padding: 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg2); color: var(--text);
  font: 15px 'Golos Text', sans-serif;
}
.user-select:focus { outline: none; border-color: var(--accent); }

.checkbox-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.checkbox-item {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; background: var(--bg2);
  border-radius: 10px; cursor: pointer;
  box-shadow: var(--shadow); font-size: 14px;
}
.checkbox-item input { width: 18px; height: 18px; accent-color: var(--accent); }

/* EMPTY */
.empty { text-align: center; padding: 40px 20px; color: var(--hint); }
.empty-icon { font-size: 44px; margin-bottom: 10px; }

/* PREVIEW */
.proj-preview-box {
  display: inline-block;
  border: 2px solid var(--accent);
  border-radius: var(--radius);
  padding: 18px 20px; text-align: center;
  min-width: 130px; margin-top: 12px;
  background: var(--bg2);
}
.proj-preview-abbr { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
.proj-preview-name { font-size: 12px; color: var(--hint); }

</style>
</head>
<body>

<!-- NAV -->
<div class="nav" id="nav">
  <button class="nav-btn active" data-page="home">üè† –ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-btn" data-page="report">üìù –û—Ç—á—ë—Ç</button>
  <button class="nav-btn" data-page="my-stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button class="nav-btn admin-only" data-page="admin-panel" style="display:none">üëë –ê–¥–º–∏–Ω</button>
</div>

<!-- HOME -->
<div class="page active" id="home">
  <div class="page-title">üëã –£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏</div>
  <div class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
  <div class="menu-grid">
    <div class="menu-card" onclick="nav('report')">
      <div class="menu-icon">üìù</div>
      <div class="menu-title">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</div>
      <div class="menu-desc">–ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è</div>
    </div>
    <div class="menu-card" onclick="nav('my-stats')">
      <div class="menu-icon">üìä</div>
      <div class="menu-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="menu-desc">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
    </div>
    <div class="menu-card admin-only" style="display:none" onclick="nav('admin-panel')">
      <div class="menu-icon">üëë</div>
      <div class="menu-title">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
      <div class="menu-desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
    </div>
  </div>
</div>

<!-- REPORT -->
<div class="page" id="report">
  <div class="page-title">üìù –ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</div>
  <div class="page-sub">–®–∞–≥ 1 –∏–∑ 3 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç(—ã)</div>

  <div class="form-group">
    <div class="form-label">üìÅ –ü—Ä–æ–µ–∫—Ç</div>
    <div class="projects-grid" id="projectsGrid"></div>
    <div class="error-msg" id="projError">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç</div>
    <button class="dashed-btn admin-only" style="display:none" onclick="nav('add-project')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  </div>

  <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
  <div id="selectedProjectsWrap" style="display:none">
    <div class="form-label">‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
    <div id="selectedProjectsList"></div>

    <!-- –ß–∞—Å—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ -->
    <div id="hoursWrap">
      <div class="form-label" id="hoursLabel">‚è±Ô∏è –ß–∞—Å–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</div>
      <div class="hours-box">
        <div>
          <div class="hours-big" id="hoursDisplay">4</div>
          <div class="hours-unit">—á–∞—Å–æ–≤</div>
        </div>
        <div style="font-size:13px;color:var(--hint);text-align:right">
          –ò—Ç–æ–≥–æ: <b id="totalHoursDisplay">0</b> —á
        </div>
      </div>
      <input type="range" id="hoursRange" min="0.5" max="12" step="0.5" value="4">
      <div class="quick-grid">
        <button class="quick-btn" data-h="2">2—á</button>
        <button class="quick-btn" data-h="4">4—á</button>
        <button class="quick-btn" data-h="6">6—á</button>
        <button class="quick-btn" data-h="8">8—á</button>
      </div>
      <button class="btn btn-secondary" style="margin-top:12px" onclick="addCurrentProject()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –ø—Ä–æ–µ–∫—Ç</button>
    </div>
  </div>

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
  <div class="form-group" id="commentWrap" style="display:none">
    <div class="form-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π <span style="color:var(--hint);font-weight:400">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></div>
    <textarea id="comment" placeholder="–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è?"></textarea>
  </div>

  <!-- –°–≤–æ–¥–∫–∞ -->
  <div class="summary" id="summary" style="display:none">
    <div class="summary-title">üìã –°–≤–æ–¥–∫–∞ –æ—Ç—á—ë—Ç–∞</div>
    <div id="summaryRows"></div>
  </div>

  <button class="btn btn-primary" id="submitBtn" style="display:none" onclick="submitReport()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- MY STATS -->
<div class="page" id="my-stats">
  <div class="page-title">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="page-sub" id="myStatsSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="myStatsContent"></div>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="admin-panel">
  <div class="page-title">üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
  <div class="page-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
  <div class="stat-tabs">
    <button class="stat-tab active" onclick="adminTab('overview',this)">–û–±–∑–æ—Ä</button>
    <button class="stat-tab" onclick="adminTab('employees',this)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
    <button class="stat-tab" onclick="adminTab('projects-stat',this)">–ü—Ä–æ–µ–∫—Ç—ã</button>
    <button class="stat-tab" onclick="adminTab('reports-list',this)">–û—Ç—á—ë—Ç—ã</button>
    <button class="stat-tab" onclick="adminTab('manage',this)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
  </div>
  <div id="adminContent"></div>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- ADD PROJECT -->
<div class="page" id="add-project">
  <div class="page-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
  <div class="page-sub">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
  <div class="info-card">üí° –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (2-5 —Å–∏–º–≤–æ–ª–æ–≤), –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ</div>
  <div class="form-group">
    <div class="form-label">üî§ –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞</div>
    <input type="text" id="newAbbr" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–°" maxlength="5">
    <div class="input-hint">2-5 —Å–∏–º–≤–æ–ª–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ CAPS</div>
    <div class="error-msg" id="abbrErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)</div>
  </div>
  <div class="form-group">
    <div class="form-label">üìù –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
    <input type="text" id="newFull" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞" maxlength="50">
    <div class="input-hint">–î–æ 50 —Å–∏–º–≤–æ–ª–æ–≤</div>
    <div class="error-msg" id="fullErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)</div>
    <div id="projPreview" style="display:none">
      <div class="proj-preview-box">
        <div class="proj-preview-abbr" id="previewAbbr">–†–°</div>
        <div class="proj-preview-name" id="previewFull">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞</div>
      </div>
    </div>
  </div>
  <button class="btn btn-primary" onclick="submitAddProject()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  <button class="btn btn-secondary" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let APP = {
  admin: false,
  userId: 0,
  username: '',
  projects: [],
  allProjects: [],
  allUsers: [],
  userStats: {},
  adminStats: null,
  selectedProject: null,
  currentHours: 4,
  reportItems: [],
  navHistory: [],
  adminChart: null,
  projChart: null,
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get('data');
  if (raw) {
    try {
      const d = JSON.parse(decodeURIComponent(raw));
      APP.admin = !!d.admin;
      APP.userId = d.user_id || 0;
      APP.username = d.username || '';
      APP.projects = d.projects || [];
      APP.allProjects = d.all_projects || d.projects || [];
      APP.allUsers = d.all_users || [];
      APP.userStats = d.user_stats || {};
      APP.adminStats = d.admin_stats || null;
    } catch(e) { console.error('Init error', e); }
  }

  // Demo data if empty
  if (!APP.projects.length) {
    APP.projects = APP.allProjects = [
      {abbr:'–†–°',full:'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞'},
      {abbr:'–ú–†–ö',full:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥'},
      {abbr:'–ö–ü',full:'–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'},
      {abbr:'–î–ó',full:'–î–∏–∑–∞–π–Ω'},
    ];
  }

  if (APP.admin) {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
  }

  buildProjectsGrid();
  renderMyStats();
  renderAdminOverview();
  initHoursSlider();
  initAddProjectForm();
  initNav();

  // Back button
  tg.BackButton.onClick(() => goBack());
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function nav(pageId) {
  const current = document.querySelector('.page.active');
  if (current) APP.navHistory.push(current.id);

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  document.getElementById(pageId).classList.add('active');
  const btn = document.querySelector(`[data-page="${pageId}"]`);
  if (btn) btn.classList.add('active');

  window.scrollTo(0, 0);

  // Back button visibility
  if (APP.navHistory.length > 0) tg.BackButton.show();
  else tg.BackButton.hide();

  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function goBack() {
  if (APP.navHistory.length > 0) {
    const prev = APP.navHistory.pop();
    nav(prev);
    if (APP.navHistory.length === 0) tg.BackButton.hide();
  }
}

function initNav() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = btn.dataset.page;
      if (p) { APP.navHistory = []; nav(p); }
    });
  });
}

// ‚îÄ‚îÄ PROJECTS GRID ‚îÄ‚îÄ
function buildProjectsGrid() {
  const grid = document.getElementById('projectsGrid');
  grid.innerHTML = '';
  APP.projects.forEach(proj => {
    const card = document.createElement('div');
    card.className = 'proj-card';
    card.innerHTML = `<div class="proj-abbr">${proj.abbr}</div><div class="proj-name">${proj.full}</div>`;
    card.onclick = () => selectProject(proj, card);
    grid.appendChild(card);
  });
}

function selectProject(proj, card) {
  // –ï—Å–ª–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  if (APP.reportItems.find(i => i.project === proj.full)) return;

  document.querySelectorAll('.proj-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  APP.selectedProject = proj;
  APP.currentHours = 4;
  document.getElementById('hoursRange').value = 4;
  document.getElementById('hoursDisplay').textContent = 4;
  updateQuickBtns(4);

  document.getElementById('projError').classList.remove('show');
  document.getElementById('selectedProjectsWrap').style.display = 'block';
  document.getElementById('hoursLabel').textContent = `‚è±Ô∏è –ß–∞—Å–æ–≤ –¥–ª—è ¬´${proj.full}¬ª`;
  updateSummary();

  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function addCurrentProject() {
  if (!APP.selectedProject) return;
  APP.reportItems.push({ project: APP.selectedProject.full, abbr: APP.selectedProject.abbr, hours: APP.currentHours });
  APP.selectedProject = null;
  document.querySelectorAll('.proj-card').forEach(c => c.classList.remove('selected'));
  renderSelectedList();
  updateSummary();
  document.getElementById('hoursWrap').style.display = 'none';
  document.getElementById('commentWrap').style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
  updateTotalHours();
}

function removeItem(idx) {
  APP.reportItems.splice(idx, 1);
  renderSelectedList();
  updateSummary();
  if (!APP.reportItems.length) {
    document.getElementById('commentWrap').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
  }
}

function renderSelectedList() {
  const list = document.getElementById('selectedProjectsList');
  list.innerHTML = '';
  APP.reportItems.forEach((item, idx) => {
    const el = document.createElement('div');
    el.className = 'project-list-item';
    el.innerHTML = `<span class="proj-list-name">${item.abbr} ‚Äî ${item.project}</span><span class="proj-list-hours">${item.hours} —á</span><button class="remove-btn" onclick="removeItem(${idx})">‚úï</button>`;
    list.appendChild(el);
  });
  updateTotalHours();
}

function updateTotalHours() {
  const total = APP.reportItems.reduce((s, i) => s + i.hours, 0) + (APP.selectedProject ? APP.currentHours : 0);
  document.getElementById('totalHoursDisplay').textContent = total;
}

function updateSummary() {
  const s = document.getElementById('summary');
  const rows = document.getElementById('summaryRows');
  const allItems = [...APP.reportItems];
  if (APP.selectedProject) allItems.push({ project: APP.selectedProject.full, hours: APP.currentHours });
  if (!allItems.length) { s.style.display = 'none'; return; }

  s.style.display = 'block';
  const total = allItems.reduce((s, i) => s + i.hours, 0);
  const comment = document.getElementById('comment')?.value || '';
  rows.innerHTML = allItems.map(i => `<div class="summary-row"><span class="summary-key">${i.project}</span><span class="summary-val">${i.hours} —á</span></div>`).join('')
    + `<div class="summary-row"><span class="summary-key">–ò—Ç–æ–≥–æ</span><span class="summary-val" style="color:var(--accent)">${total} —á</span></div>`
    + (comment ? `<div class="summary-row"><span class="summary-key">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span><span class="summary-val">${comment}</span></div>` : '');

  document.getElementById('commentWrap').style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
}

// ‚îÄ‚îÄ HOURS SLIDER ‚îÄ‚îÄ
function initHoursSlider() {
  const range = document.getElementById('hoursRange');
  range.addEventListener('input', e => {
    APP.currentHours = parseFloat(e.target.value);
    document.getElementById('hoursDisplay').textContent = APP.currentHours;
    updateQuickBtns(APP.currentHours);
    updateSummary(); updateTotalHours();
  });
  document.querySelectorAll('.quick-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      APP.currentHours = parseFloat(btn.dataset.h);
      range.value = APP.currentHours;
      document.getElementById('hoursDisplay').textContent = APP.currentHours;
      updateQuickBtns(APP.currentHours);
      updateSummary(); updateTotalHours();
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    });
  });
  updateQuickBtns(4);
}

function updateQuickBtns(val) {
  document.querySelectorAll('.quick-btn').forEach(b => {
    b.classList.toggle('active', parseFloat(b.dataset.h) === val);
  });
}

// ‚îÄ‚îÄ SUBMIT REPORT ‚îÄ‚îÄ
function submitReport() {
  // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—â—ë –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
  if (APP.selectedProject) {
    APP.reportItems.push({ project: APP.selectedProject.full, abbr: APP.selectedProject.abbr, hours: APP.currentHours });
  }
  if (!APP.reportItems.length) {
    document.getElementById('projError').classList.add('show');
    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
    return;
  }
  const data = {
    type: 'report',
    projects: APP.reportItems.map(i => ({ project: i.project, hours: i.hours })),
    comments: document.getElementById('comment').value || '-'
  };
  tg.sendData(JSON.stringify(data));
  tg.close();
}

// ‚îÄ‚îÄ ADD PROJECT FORM ‚îÄ‚îÄ
function initAddProjectForm() {
  document.getElementById('newAbbr').addEventListener('input', e => {
    e.target.value = e.target.value.toUpperCase();
    updateProjPreview();
  });
  document.getElementById('newFull').addEventListener('input', updateProjPreview);
}

function updateProjPreview() {
  const a = document.getElementById('newAbbr').value.trim();
  const f = document.getElementById('newFull').value.trim();
  const preview = document.getElementById('projPreview');
  if (a || f) {
    preview.style.display = 'block';
    document.getElementById('previewAbbr').textContent = a || '–ê–ë–í';
    document.getElementById('previewFull').textContent = f || '–ù–∞–∑–≤–∞–Ω–∏–µ';
  } else {
    preview.style.display = 'none';
  }
}

function submitAddProject() {
  const abbr = document.getElementById('newAbbr').value.trim();
  const full = document.getElementById('newFull').value.trim();
  let ok = true;
  if (abbr.length < 2) { document.getElementById('abbrErr').classList.add('show'); ok = false; }
  else document.getElementById('abbrErr').classList.remove('show');
  if (full.length < 3) { document.getElementById('fullErr').classList.add('show'); ok = false; }
  else document.getElementById('fullErr').classList.remove('show');
  if (APP.allProjects.find(p => p.abbr === abbr)) {
    document.getElementById('abbrErr').textContent = '–ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
    document.getElementById('abbrErr').classList.add('show'); ok = false;
  }
  if (!ok) { if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); return; }
  tg.sendData(JSON.stringify({ type: 'add_project', abbr, full }));
  tg.close();
}

// ‚îÄ‚îÄ MY STATS ‚îÄ‚îÄ
function renderMyStats() {
  const content = document.getElementById('myStatsContent');
  const s = APP.userStats;
  if (!s || !s.total_reports) {
    document.getElementById('myStatsSubtitle').textContent = '–ï—â—ë –Ω–µ—Ç –æ—Ç—á—ë—Ç–æ–≤';
    content.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><div>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –æ—Ç—á—ë—Ç!</div></div>`;
    return;
  }
  document.getElementById('myStatsSubtitle').textContent = `–í—Å–µ–≥–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è`;
  let html = `
    <div class="card"><div class="card-row"><div class="card-label">‚è±Ô∏è –í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="card-value">${s.total_hours}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üìù –û—Ç—á—ë—Ç–æ–≤</div><div class="card-value">${s.total_reports}</div></div></div>
    <div class="form-label" style="margin-top:4px">üìÅ –ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º</div>
  `;
  Object.entries(s.by_project || {}).sort((a,b)=>b[1]-a[1]).forEach(([proj, h]) => {
    html += `<div class="card"><div class="card-row"><span>${proj}</span><span style="font-weight:700;color:var(--accent)">${h} —á</span></div></div>`;
  });
  content.innerHTML = html;
}

// ‚îÄ‚îÄ ADMIN TABS ‚îÄ‚îÄ
let currentAdminTab = 'overview';
function adminTab(tab, btn) {
  document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentAdminTab = tab;
  renderAdminTab(tab);
}

function renderAdminTab(tab) {
  if (tab === 'overview') renderAdminOverview();
  else if (tab === 'employees') renderAdminEmployees();
  else if (tab === 'projects-stat') renderAdminProjects();
  else if (tab === 'reports-list') renderAdminReports();
  else if (tab === 'manage') renderAdminManage();
}

function renderAdminOverview() {
  if (!document.getElementById('admin-panel').classList.contains('active') && currentAdminTab !== 'overview') return;
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`;
    return;
  }
  content.innerHTML = `
    <div class="card"><div class="card-row"><div class="card-label">‚è±Ô∏è –í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="card-value">${s.total_hours}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üìù –û—Ç—á—ë—Ç–æ–≤</div><div class="card-value">${s.total_reports}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div><div class="card-value">${s.employees?.length||0}</div></div></div>
    <div class="chart-wrap"><canvas id="overviewChart"></canvas></div>
  `;
  if (s.employees?.length && typeof Chart !== 'undefined') {
    if (APP.adminChart) APP.adminChart.destroy();
    const ctx = document.getElementById('overviewChart');
    APP.adminChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: s.employees.map(e=>e.name),
        datasets: [{ label:'–ß–∞—Å—ã', data: s.employees.map(e=>e.hours), backgroundColor: 'rgba(37,99,235,0.7)', borderRadius: 6 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }
}

function renderAdminEmployees() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.employees?.length) { content.innerHTML = `<div class="empty"><div class="empty-icon">üë•</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`; return; }
  content.innerHTML = [...s.employees].sort((a,b)=>b.hours-a.hours).map(emp => `
    <div class="emp-card">
      <div class="emp-header">
        <div class="emp-name">üë§ ${emp.name}</div>
        <div class="emp-hours">${emp.hours} —á</div>
      </div>
      <div style="font-size:13px;color:var(--hint);margin-bottom:8px">üìù –û—Ç—á—ë—Ç–æ–≤: ${emp.reports}</div>
      ${Object.entries(emp.projects||{}).map(([p,h])=>`<div class="emp-proj"><span class="emp-proj-name">${p}</span><span>${h} —á</span></div>`).join('')}
    </div>
  `).join('');
}

function renderAdminProjects() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.projects) { content.innerHTML = `<div class="empty"><div class="empty-icon">üìÅ</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`; return; }
  const sorted = Object.entries(s.projects).sort((a,b)=>b[1]-a[1]);
  content.innerHTML = sorted.map(([p,h])=>`<div class="card"><div class="card-row"><span>${p}</span><span style="font-weight:700;color:var(--accent)">${h} —á</span></div></div>`).join('')
    + `<div class="chart-wrap"><canvas id="projChart"></canvas></div>`;
  if (sorted.length && typeof Chart !== 'undefined') {
    if (APP.projChart) APP.projChart.destroy();
    APP.projChart = new Chart(document.getElementById('projChart'), {
      type: 'doughnut',
      data: {
        labels: sorted.map(([p])=>p),
        datasets: [{ data: sorted.map(([,h])=>h), backgroundColor: ['#2563eb','#16a34a','#d97706','#9333ea','#ef4444','#0891b2'], borderWidth:0 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{font:{size:12}}}} }
    });
  }
}

function renderAdminReports() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.recent_reports?.length) { content.innerHTML = `<div class="empty"><div class="empty-icon">üìù</div><div>–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</div></div>`; return; }
  content.innerHTML = s.recent_reports.map(r=>`
    <div class="report-item">
      <div class="report-header">
        <span class="report-emp">üë§ ${r.employee}</span>
        <span class="report-date">${r.date} ${r.time}</span>
      </div>
      <div class="report-proj">üìÅ ${r.project} ‚Äî ${r.hours} —á</div>
      ${r.comment && r.comment !== '-' ? `<div class="report-comment">üí¨ ${r.comment}</div>` : ''}
    </div>
  `).join('');
}

function renderAdminManage() {
  const content = document.getElementById('adminContent');
  const projs = APP.allProjects;
  const users = APP.allUsers;

  content.innerHTML = `
    <div class="form-label">üìÅ –ü—Ä–æ–µ–∫—Ç—ã (${projs.length})</div>
    ${projs.map(p=>`
      <div class="project-list-item">
        <span class="proj-list-name">${p.abbr} ‚Äî ${p.full}</span>
        <button class="remove-btn" onclick="removeProject('${p.abbr}')">‚úï</button>
      </div>`).join('')}
    <button class="btn btn-primary" onclick="nav('add-project')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>

    <div class="form-label" style="margin-top:24px">üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</div>
    <select class="user-select" id="assignUser" onchange="renderAssignProjects()">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>
      ${users.map(u=>`<option value="${u.id}">${u.username}</option>`).join('')}
    </select>
    <div id="assignProjectsList" class="checkbox-list"></div>
    <button class="btn btn-primary" id="assignBtn" style="display:none" onclick="submitAssign()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</button>
  `;
}

function removeProject(abbr) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç ${abbr}?`)) return;
  tg.sendData(JSON.stringify({ type: 'remove_project', abbr }));
  APP.allProjects = APP.allProjects.filter(p => p.abbr !== abbr);
  renderAdminManage();
}

function renderAssignProjects() {
  const uid = document.getElementById('assignUser').value;
  if (!uid) return;
  const list = document.getElementById('assignProjectsList');
  list.innerHTML = APP.allProjects.map(p => `
    <label class="checkbox-item">
      <input type="checkbox" value="${p.abbr}" checked>
      <span>${p.abbr} ‚Äî ${p.full}</span>
    </label>
  `).join('');
  document.getElementById('assignBtn').style.display = 'block';
}

function submitAssign() {
  const uid = parseInt(document.getElementById('assignUser').value);
  const uname = APP.allUsers.find(u=>u.id===uid)?.username || '';
  const checked = [...document.querySelectorAll('#assignProjectsList input:checked')].map(c=>c.value);
  tg.sendData(JSON.stringify({ type: 'assign_projects', user_id: uid, username: uname, abbrs: checked }));
  tg.close();
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
init();
</script>
</body>
</html>
