<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap');

:root {
  --accent: var(--tg-theme-button-color, #2563eb);
  --accent-light: color-mix(in srgb, var(--accent) 12%, transparent);
  --bg: var(--tg-theme-bg-color, #f8fafc);
  --bg2: var(--tg-theme-secondary-bg-color, #ffffff);
  --text: var(--tg-theme-text-color, #0f172a);
  --hint: var(--tg-theme-hint-color, #94a3b8);
  --border: color-mix(in srgb, var(--hint) 25%, transparent);
  --danger: #ef4444;
  --success: #22c55e;
  --radius: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Golos Text', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 24px;
}

/* NAV */
.nav {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  display: flex; gap: 6px;
  overflow-x: auto;
  scrollbar-width: none;
}
.nav::-webkit-scrollbar { display: none; }
.nav-btn {
  padding: 7px 14px;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  background: transparent;
  color: var(--hint);
  font: 500 13px 'Golos Text', sans-serif;
  cursor: pointer;
  white-space: nowrap;
  transition: all .2s;
  flex-shrink: 0;
}
.nav-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* PAGES */
.page { display: none; padding: 16px; animation: up .25s ease; }
.page.active { display: block; }
@keyframes up { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* HEADINGS */
.page-title {
  font-size: 22px; font-weight: 700;
  margin-bottom: 4px; letter-spacing: -.3px;
}
.page-sub { font-size: 14px; color: var(--hint); margin-bottom: 20px; }

/* CARDS */
.card {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}
.card-row {
  display: flex; justify-content: space-between; align-items: center;
}
.card-label { font-size: 14px; color: var(--hint); }
.card-value { font-size: 22px; font-weight: 700; color: var(--accent); }

/* MENU GRID */
.menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 4px; }
.menu-card {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 20px 16px;
  text-align: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform .15s, box-shadow .15s;
  border: 1.5px solid transparent;
  user-select: none;
}
.menu-card:active { transform: scale(.96); box-shadow: none; }
.menu-card:hover { border-color: var(--accent); }
.menu-icon { font-size: 32px; margin-bottom: 10px; }
.menu-title { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
.menu-desc { font-size: 12px; color: var(--hint); }

/* FORM */
.form-label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 10px;
  display: block;
  color: var(--text);
  margin-block-start: 10px;
}
.form-group { margin-bottom: 22px; }

/* PROJECT CARDS */
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; }
.proj-card {
  padding: 16px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  text-align: center;
  transition: all .2s;
  background: var(--bg2);
  user-select: none;
}
.proj-card:active { transform: scale(.95); }
.proj-card.selected {
  border-color: var(--accent);
  background: var(--accent);
  color: #fff;
}
.proj-abbr { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.proj-name { font-size: 11px; opacity: .8; line-height: 1.3; word-break: break-word; overflow-wrap: break-word; hyphens: auto; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* DASHED ADD BTN */
.dashed-btn {
  width: 100%; padding: 12px;
  border: 2px dashed var(--accent);
  border-radius: var(--radius);
  background: var(--accent-light);
  color: var(--accent);
  font: 600 14px 'Golos Text', sans-serif;
  cursor: pointer; margin-top: 10px;
  transition: opacity .2s;
}
.dashed-btn:active { opacity: .7; }

/* HOURS */
.hours-box {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 14px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: var(--shadow);
}
.hours-big { font-size: 40px; font-weight: 700; color: var(--accent); line-height: 1; }
.hours-unit { font-size: 14px; color: var(--hint); margin-top: 4px; }

input[type="range"] {
  width: 100%; height: 6px;
  border-radius: 3px;
  background: var(--border);
  outline: none;
  -webkit-appearance: none;
  padding: 0; margin-bottom: 12px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 26px; height: 26px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}
input[type="range"]::-moz-range-thumb {
  width: 26px; height: 26px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  cursor: pointer;
}

.quick-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-block-end: 10px; }
.quick-btn {
  padding: 11px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--bg2);
  color: var(--text);
  font: 600 15px 'Golos Text', sans-serif;
  cursor: pointer; transition: all .2s;
}
.quick-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}
.quick-btn:active { transform: scale(.95); }

/* TEXTAREA */
textarea, input[type="text"] {
  width: 100%; padding: 13px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  font: 15px 'Golos Text', sans-serif;
  background: var(--bg2); color: var(--text);
  resize: vertical; transition: border-color .2s;
}
textarea { min-height: 90px; }
textarea:focus, input:focus {
  outline: none; border-color: var(--accent);
}

.input-hint { font-size: 12px; color: var(--hint); margin-top: 6px; }

/* SUMMARY */
.summary {
  background: var(--accent-light);
  border: 1.5px solid var(--accent);
  border-radius: var(--radius);
  padding: 14px;
  margin-top: 16px;
}
.summary-title { font-weight: 700; font-size: 14px; margin-bottom: 10px; }
.summary-row { display: flex; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.summary-row:last-child { border: none; }
.summary-key { color: var(--hint); }
.summary-val { font-weight: 600; max-width: 60%; text-align: right; }

/* MULTI-PROJECT LIST */
.project-list-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px;
  background: var(--bg2);
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  font-size: 14px;
}
.proj-list-name { font-weight: 600; }
.proj-list-hours { color: var(--accent); font-weight: 700; }
.remove-btn {
  background: none; border: none;
  color: var(--danger); font-size: 18px;
  cursor: pointer; padding: 0 4px;
}

/* BUTTONS */
.btn {
  width: 100%; padding: 15px;
  border: none; border-radius: var(--radius);
  font: 600 15px 'Golos Text', sans-serif;
  cursor: pointer; margin-top: 10px;
  transition: opacity .2s, transform .15s;
}
.btn:active { transform: scale(.98); opacity: .9; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-secondary {
  background: transparent;
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
.btn-danger {
  background: transparent;
  color: var(--danger);
  border: 1.5px solid var(--danger);
}

/* ERROR */
.error-msg { font-size: 13px; color: var(--danger); margin-top: 6px; display: none; }
.error-msg.show { display: block; }

/* INFO */
.info-card {
  background: var(--accent-light);
  border-left: 4px solid var(--accent);
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  margin-bottom: 16px;
  line-height: 1.5;
}

/* STAT TABS */
.stat-tabs { display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto; }
.stat-tab {
  padding: 7px 14px; border-radius: 20px;
  border: 1.5px solid var(--border);
  background: transparent; color: var(--hint);
  font: 500 13px 'Golos Text', sans-serif;
  cursor: pointer; white-space: nowrap;
  flex-shrink: 0; transition: all .2s;
}
.stat-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* EMPLOYEE CARD */
.emp-card {
  background: var(--bg2); border-radius: var(--radius);
  padding: 14px; margin-bottom: 10px;
  box-shadow: var(--shadow);
}
.emp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.emp-name { font-weight: 700; font-size: 15px; }
.emp-hours { font-size: 20px; font-weight: 700; color: var(--accent); }
.emp-proj { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
.emp-proj:last-child { border: none; }
.emp-proj-name { color: var(--hint); }

/* REPORT ITEM */
.report-item {
  background: var(--bg2); border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  box-shadow: var(--shadow); font-size: 13px;
}
.report-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
.report-emp { font-weight: 700; }
.report-date { color: var(--hint); font-size: 12px; }
.report-proj { color: var(--accent); font-weight: 600; }
.report-comment { color: var(--hint); margin-top: 4px; font-style: italic; }

/* CHART */
.chart-wrap {
  background: var(--bg2); border-radius: var(--radius);
  padding: 14px; margin-bottom: 12px;
  box-shadow: var(--shadow); height: 220px;
}

/* ASSIGN */
.user-select {
  width: 100%; padding: 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg2); color: var(--text);
  font: 15px 'Golos Text', sans-serif;
}
.user-select:focus { outline: none; border-color: var(--accent); }

.checkbox-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.checkbox-item {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; background: var(--bg2);
  border-radius: 10px; cursor: pointer;
  box-shadow: var(--shadow); font-size: 14px;
}
.checkbox-item input { width: 18px; height: 18px; accent-color: var(--accent); }

/* PROJECT COMMENT INPUT */
.project-list-item-wrap { margin-bottom: 12px; }
.proj-comment-input {
  width: 100%; padding: 10px 12px; margin-top: 6px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font: 13px 'Golos Text', sans-serif;
  background: var(--bg2); color: var(--text);
  resize: none; height: 60px;
  transition: border-color .2s;
}
.proj-comment-input:focus { outline: none; border-color: var(--accent); }

/* EMPTY */
.empty { text-align: center; padding: 40px 20px; color: var(--hint); }
.empty-icon { font-size: 44px; margin-bottom: 10px; }

/* MODAL */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.5); z-index: 200;
  align-items: flex-end; justify-content: center;
}
.modal-overlay.open { display: flex; animation: fadeIn .2s; }
.modal-box {
  background: var(--bg2); border-radius: 20px 20px 0 0;
  padding: 20px 16px 32px; width: 100%; max-width: 600px;
  animation: slideUp .3s ease;
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 16px;
}
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
  background: none; border: none; font-size: 22px;
  color: var(--hint); cursor: pointer; padding: 4px;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

/* PREVIEW */
.proj-preview-box {
  display: inline-block;
  border: 2px solid var(--accent);
  border-radius: var(--radius);
  padding: 18px 20px; text-align: center;
  min-width: 130px; margin-top: 12px;
  background: var(--bg2);
}
.proj-preview-abbr { font-size: 20px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
.proj-preview-name { font-size: 12px; color: var(--hint); }

</style>
</head>
<body>

<!-- NAV -->
<div class="nav" id="nav">
  <button class="nav-btn active" data-page="home">üè† –ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-btn" data-page="report">üìù –û—Ç—á—ë—Ç</button>
  <button class="nav-btn" data-page="my-stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button class="nav-btn admin-only" data-page="admin-panel" style="display:none">üëë –ê–¥–º–∏–Ω</button>
</div>

<!-- HOME -->
<div class="page active" id="home">
  <div class="page-title">üëã –£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏</div>
  <div class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
  <div class="menu-grid">
    <div class="menu-card" onclick="nav('report')">
      <div class="menu-icon">üìù</div>
      <div class="menu-title">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</div>
      <div class="menu-desc">–ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è</div>
    </div>
    <div class="menu-card" onclick="nav('my-stats')">
      <div class="menu-icon">üìä</div>
      <div class="menu-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="menu-desc">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
    </div>
    <div class="menu-card admin-only" style="display:none" onclick="nav('admin-panel')">
      <div class="menu-icon">üëë</div>
      <div class="menu-title">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
      <div class="menu-desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
    </div>
  </div>
</div>

<!-- REPORT -->
<div class="page" id="report">
  <div class="page-title">üìù –ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</div>
  <div class="page-sub">–®–∞–≥ 1 –∏–∑ 3 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç(—ã)</div>

  <div class="form-group">
    <div class="form-label">üìÅ –ü—Ä–æ–µ–∫—Ç</div>
    <div class="projects-grid" id="projectsGrid"></div>
    <div class="error-msg" id="projError">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç</div>
  </div>

  <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
  <div id="selectedProjectsWrap" style="display:none">
    <div class="form-label">‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
    <div id="selectedProjectsList"></div>

    <!-- –ß–∞—Å—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ -->
    <div id="hoursWrap">
      <div class="form-label" id="hoursLabel">‚è±Ô∏è –ß–∞—Å–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</div>
      <div class="hours-box">
        <div>
          <div class="hours-big" id="hoursDisplay">4</div>
          <div class="hours-unit">—á–∞—Å–æ–≤</div>
        </div>
        <div style="font-size:13px;color:var(--hint);text-align:right">
          –ò—Ç–æ–≥–æ: <b id="totalHoursDisplay">0</b> —á
        </div>
      </div>
      <input type="range" id="hoursRange" min="0.5" max="12" step="0.5" value="4">
      <div class="quick-grid">
        <button class="quick-btn" data-h="2">2—á</button>
        <button class="quick-btn" data-h="4">4—á</button>
        <button class="quick-btn" data-h="6">6—á</button>
        <button class="quick-btn" data-h="8">8—á</button>
      </div>
      <button class="btn btn-secondary" style="margin-top:12px" onclick="addCurrentProject()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –ø—Ä–æ–µ–∫—Ç</button>
    </div>
  </div>

  <!-- –û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
  <div class="form-group" id="commentWrap" style="display:none">
    <div class="form-label">üí¨ –û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π <span style="color:var(--hint);font-weight:400">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></div>
    <textarea id="comment" placeholder="–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å..."></textarea>
  </div>

  <!-- –°–≤–æ–¥–∫–∞ -->
  <div class="summary" id="summary" style="display:none">
    <div class="summary-title">üìã –°–≤–æ–¥–∫–∞ –æ—Ç—á—ë—Ç–∞</div>
    <div id="summaryRows"></div>
  </div>

  <button class="btn btn-primary" id="submitBtn" style="display:none" onclick="submitReport()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- MY STATS -->
<div class="page" id="my-stats">
  <div class="page-title">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="page-sub" id="myStatsSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="myStatsContent"></div>
  <div class="info-card" style="margin-top:8px;font-size:12px">
    üí° –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ /start
  </div>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="admin-panel">
  <div class="page-title">üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
  <div class="page-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
  <div class="stat-tabs">
    <button class="stat-tab active" onclick="adminTab('overview',this)">–û–±–∑–æ—Ä</button>
    <button class="stat-tab" onclick="adminTab('employees',this)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
    <button class="stat-tab" onclick="adminTab('projects-stat',this)">–ü—Ä–æ–µ–∫—Ç—ã</button>
    <button class="stat-tab" onclick="adminTab('reports-list',this)">–û—Ç—á—ë—Ç—ã</button>
    <button class="stat-tab" onclick="adminTab('manage',this)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
  </div>
  <div id="adminContent"></div>
  <button class="btn btn-secondary" onclick="nav('home')">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<!-- ADD PROJECT -->
<div class="page" id="add-project">
  <div class="page-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
  <div class="page-sub">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
  <div class="info-card">üí° –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (2-5 —Å–∏–º–≤–æ–ª–æ–≤), –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ</div>
  <div class="form-group">
    <div class="form-label">üî§ –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞</div>
    <input type="text" id="newAbbr" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–°" maxlength="5">
    <div class="input-hint">2-5 —Å–∏–º–≤–æ–ª–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ CAPS</div>
    <div class="error-msg" id="abbrErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)</div>
  </div>
  <div class="form-group">
    <div class="form-label">üìù –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
    <input type="text" id="newFull" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞" maxlength="50">
    <div class="input-hint">–î–æ 50 —Å–∏–º–≤–æ–ª–æ–≤</div>
    <div class="error-msg" id="fullErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)</div>
    <div id="projPreview" style="display:none">
      <div class="proj-preview-box">
        <div class="proj-preview-abbr" id="previewAbbr">–†–°</div>
        <div class="proj-preview-name" id="previewFull">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞</div>
      </div>
    </div>
  </div>
  <button class="btn btn-primary" onclick="submitAddProject()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  <button class="btn btn-secondary" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
</div>

<!-- ADD PROJECT MODAL -->
<div class="modal-overlay" id="addProjModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="info-card">üí° –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ ‚Äî 2-5 —Å–∏–º–≤–æ–ª–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ</div>
    <div class="form-group">
      <div class="form-label">üî§ –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞</div>
      <input type="text" id="newAbbr" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–°" maxlength="5">
      <div class="error-msg" id="abbrErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞)</div>
    </div>
    <div class="form-group">
      <div class="form-label">üìù –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
      <input type="text" id="newFull" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞" maxlength="50">
      <div class="error-msg" id="fullErr">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)</div>
    </div>
    <div id="projPreview" style="display:none;margin-bottom:16px">
      <div class="proj-preview-box">
        <div class="proj-preview-abbr" id="previewAbbr">–†–°</div>
        <div class="proj-preview-name" id="previewFull">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="submitAddProject()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let APP = {
  admin: false,
  userId: 0,
  username: '',
  projects: [],
  allProjects: [],
  allUsers: [],
  userStats: {},
  adminStats: null,
  selectedProject: null,
  currentHours: 4,
  reportItems: [],
  navHistory: [],
  adminChart: null,
  projChart: null,
  pendingActions: [],
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get('data');
  if (raw) {
    try {
      const d = JSON.parse(decodeURIComponent(raw));
      APP.admin = !!d.admin;
      APP.userId = d.user_id || 0;
      APP.username = d.username || '';
      APP.projects = d.projects || [];
      APP.allProjects = d.all_projects || d.projects || [];
      APP.allUsers = d.all_users || [];
      APP.userStats = d.user_stats || {};
      APP.adminStats = d.admin_stats || null;
    } catch(e) { console.error('Init error', e); }
  }

  // Demo data if empty
  if (!APP.projects.length) {
    APP.projects = APP.allProjects = [
      {abbr:'–†–°',full:'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞'},
      {abbr:'–ú–†–ö',full:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥'},
      {abbr:'–ö–ü',full:'–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞'},
      {abbr:'–î–ó',full:'–î–∏–∑–∞–π–Ω'},
    ];
  }

  if (APP.admin) {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
  }

  buildProjectsGrid();
  renderMyStats();
  renderAdminOverview();
  initHoursSlider();
  initAddProjectForm();
  initNav();

  // Back button
  tg.BackButton.onClick(() => goBack());
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function nav(pageId, addToHistory = true) {
  const current = document.querySelector('.page.active');
  if (current && addToHistory && current.id !== pageId) {
    APP.navHistory.push(current.id);
  }

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  document.getElementById(pageId).classList.add('active');
  const btn = document.querySelector(`[data-page="${pageId}"]`);
  if (btn) btn.classList.add('active');

  window.scrollTo(0, 0);

  // Back button visibility
  if (APP.navHistory.length > 0) tg.BackButton.show();
  else tg.BackButton.hide();

  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

function goBack() {
  if (APP.navHistory.length > 0) {
    const prev = APP.navHistory.pop();
    nav(prev, false); // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞–∑–∞–¥
  } else {
    // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç ‚Äî –∏–¥—ë–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    nav('home', false);
  }
}

function initNav() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = btn.dataset.page;
      if (p) { APP.navHistory = []; nav(p); }
    });
  });
}

// ‚îÄ‚îÄ PROJECTS GRID ‚îÄ‚îÄ
function buildProjectsGrid() {
  const grid = document.getElementById('projectsGrid');
  grid.innerHTML = '';
  APP.projects.forEach(proj => {
    const card = document.createElement('div');
    card.className = 'proj-card';
    card.innerHTML = `<div class="proj-abbr">${proj.abbr}</div><div class="proj-name">${proj.full}</div>`;
    card.onclick = () => selectProject(proj, card);
    grid.appendChild(card);
  });
}

function selectProject(proj, card) {
  if (APP.reportItems.find(i => i.project === proj.full)) return;

  document.querySelectorAll('.proj-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  APP.selectedProject = proj;

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–∞—Å—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  if (APP.reportItems.length === 0) {
    APP.currentHours = 4;
    document.getElementById('hoursRange').value = 4;
    document.getElementById('hoursDisplay').textContent = 4;
    updateQuickBtns(4);
  } else {
    document.getElementById('hoursDisplay').textContent = APP.currentHours;
    document.getElementById('hoursRange').value = APP.currentHours;
    updateQuickBtns(APP.currentHours);
  }

  document.getElementById('projError').classList.remove('show');
  document.getElementById('selectedProjectsWrap').style.display = 'block';
  document.getElementById('hoursWrap').style.display = 'block';
  document.getElementById('hoursLabel').textContent = `‚è±Ô∏è –ß–∞—Å–æ–≤ –¥–ª—è ¬´${proj.full}¬ª`;
  updateSummary();

  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

  // –°–∫—Ä–æ–ª–ª–∏–º –∫ —Å–ª–∞–π–¥–µ—Ä—É
  setTimeout(() => document.getElementById('hoursWrap').scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

function addCurrentProject() {
  if (!APP.selectedProject) return;
  APP.reportItems.push({ project: APP.selectedProject.full, abbr: APP.selectedProject.abbr, hours: APP.currentHours, comment: '' });
  APP.selectedProject = null;

  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–±–æ—Ä–∞
  document.querySelectorAll('.proj-card').forEach(c => {
    c.classList.remove('selected');
    // –°–µ—Ä—ã–º –æ—Ç–º–µ—á–∞–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ
    const alreadyAdded = APP.reportItems.find(i => i.abbr === c.querySelector('.proj-abbr').textContent);
    c.style.opacity = alreadyAdded ? '0.4' : '1';
    c.style.pointerEvents = alreadyAdded ? 'none' : 'auto';
  });

  renderSelectedList();
  updateSummary();

  // –ü—Ä—è—á–µ–º —Å–ª–∞–π–¥–µ—Ä, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≥—Ä–∏–¥ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –µ—â—ë
  document.getElementById('hoursWrap').style.display = 'none';
  document.getElementById('hoursLabel').textContent = '‚è±Ô∏è –ß–∞—Å–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
  document.getElementById('commentWrap').style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
  updateTotalHours();

  showToast(`‚ûï ${APP.reportItems[APP.reportItems.length-1].project} –¥–æ–±–∞–≤–ª–µ–Ω`, 'info');
}

function removeItem(idx) {
  const removed = APP.reportItems[idx];
  APP.reportItems.splice(idx, 1);

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ–µ–∫—Ç–∞
  document.querySelectorAll('.proj-card').forEach(c => {
    if (c.querySelector('.proj-abbr').textContent === removed.abbr) {
      c.style.opacity = '1';
      c.style.pointerEvents = 'auto';
    }
  });

  renderSelectedList();
  updateSummary();
  if (!APP.reportItems.length && !APP.selectedProject) {
    document.getElementById('commentWrap').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('summary').style.display = 'none';
  }
}

function renderSelectedList() {
  const list = document.getElementById('selectedProjectsList');
  list.innerHTML = '';
  APP.reportItems.forEach((item, idx) => {
    const el = document.createElement('div');
    el.style.cssText = 'background:var(--bg2);border-radius:12px;padding:12px 14px;margin-bottom:10px;box-shadow:var(--shadow)';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:600;font-size:14px;flex:1;margin-right:8px">${item.abbr} ‚Äî ${item.project}</span>
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
          <span style="font-weight:700;color:var(--accent);font-size:15px">${item.hours} —á</span>
          <button onclick="removeItem(${idx})" style="background:none;border:none;color:var(--danger);font-size:18px;cursor:pointer;padding:0;line-height:1">‚úï</button>
        </div>
      </div>
      <input type="text"
        placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ ${item.project} (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
        value="${(item.comment || '').replace(/"/g, '&quot;')}"
        oninput="APP.reportItems[${idx}].comment = this.value; updateSummary()"
        style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font:14px 'Golos Text',sans-serif;background:var(--bg);color:var(--text);box-sizing:border-box;outline:none"
        onfocus="this.style.borderColor='var(--accent)'"
        onblur="this.style.borderColor='var(--border)'"
      >
    `;
    list.appendChild(el);
  });
  updateTotalHours();
}

function updateTotalHours() {
  const total = APP.reportItems.reduce((s, i) => s + i.hours, 0) + (APP.selectedProject ? APP.currentHours : 0);
  document.getElementById('totalHoursDisplay').textContent = total;
}

function updateSummary() {
  const s = document.getElementById('summary');
  const rows = document.getElementById('summaryRows');
  const allItems = [...APP.reportItems];
  if (APP.selectedProject) allItems.push({ project: APP.selectedProject.full, hours: APP.currentHours });
  if (!allItems.length) { s.style.display = 'none'; return; }

  s.style.display = 'block';
  const total = allItems.reduce((s, i) => s + i.hours, 0);
  rows.innerHTML = allItems.map(i => `
    <div class="summary-row">
      <span class="summary-key">${i.project}</span>
      <span class="summary-val">${i.hours} —á${i.comment ? ' ¬∑ ' + i.comment : ''}</span>
    </div>`).join('')
    + `<div class="summary-row"><span class="summary-key" style="font-weight:700">–ò—Ç–æ–≥–æ</span><span class="summary-val" style="color:var(--accent);font-weight:700">${total} —á</span></div>`;

  document.getElementById('commentWrap').style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
}

// ‚îÄ‚îÄ HOURS SLIDER ‚îÄ‚îÄ
function initHoursSlider() {
  const range = document.getElementById('hoursRange');
  range.addEventListener('input', e => {
    APP.currentHours = parseFloat(e.target.value);
    document.getElementById('hoursDisplay').textContent = APP.currentHours;
    updateQuickBtns(APP.currentHours);
    updateSummary(); updateTotalHours();
  });
  document.querySelectorAll('.quick-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      APP.currentHours = parseFloat(btn.dataset.h);
      range.value = APP.currentHours;
      document.getElementById('hoursDisplay').textContent = APP.currentHours;
      updateQuickBtns(APP.currentHours);
      updateSummary(); updateTotalHours();
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    });
  });
  updateQuickBtns(4);
}

function updateQuickBtns(val) {
  document.querySelectorAll('.quick-btn').forEach(b => {
    b.classList.toggle('active', parseFloat(b.dataset.h) === val);
  });
}

// ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ
function showConfirm(message, onConfirm) {
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –µ—Å–ª–∏ –µ—Å—Ç—å
  const old = document.getElementById('confirmDialog');
  if (old) old.remove();
  
  const dialog = document.createElement('div');
  dialog.id = 'confirmDialog';
  dialog.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,.5);
    display:flex; align-items:center; justify-content:center;
    z-index:10000; padding:16px;
  `;
  dialog.innerHTML = `
    <div style="background:var(--bg2);border-radius:16px;padding:20px;max-width:320px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.2)">
      <div style="font-weight:600;font-size:16px;margin-bottom:8px">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
      <div style="color:var(--hint);font-size:14px;margin-bottom:20px">${message}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button onclick="document.getElementById('confirmDialog').remove()" 
          style="padding:12px;border:1.5px solid var(--border);border-radius:10px;background:transparent;color:var(--text);font:600 14px inherit;cursor:pointer">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button id="confirmOkBtn"
          style="padding:12px;border:none;border-radius:10px;background:var(--danger);color:#fff;font:600 14px inherit;cursor:pointer">
          –£–¥–∞–ª–∏—Ç—å
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(dialog);
  document.getElementById('confirmOkBtn').onclick = () => {
    dialog.remove();
    onConfirm();
  };
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type = 'success') {
  const existing = document.getElementById('toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'toast';
  toast.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:${type==='success'?'#22c55e':type==='error'?'#ef4444':'var(--accent)'};color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.2);max-width:80vw;text-align:center;`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2500);
}

// ‚îÄ‚îÄ SUBMIT REPORT ‚îÄ‚îÄ
function submitReport() {
  if (APP.selectedProject) {
    APP.reportItems.push({ project: APP.selectedProject.full, abbr: APP.selectedProject.abbr, hours: APP.currentHours });
    APP.selectedProject = null;
  }
  if (!APP.reportItems.length) {
    document.getElementById('projError').classList.add('show');
    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
    return;
  }

  const generalComment = document.getElementById('comment').value || '';
  const data = {
    type: 'report',
    projects: APP.reportItems.map(i => ({ 
      project: i.project, 
      hours: i.hours,
      comment: i.comment || ''
    })),
    comments: generalComment || '-'
  };

  // –î–æ–±–∞–≤–ª—è–µ–º pending actions –µ—Å–ª–∏ –µ—Å—Ç—å
  if (APP.pendingActions && APP.pendingActions.length) {
    data.pending = APP.pendingActions;
    APP.pendingActions = [];
  }
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
  tg.sendData(JSON.stringify(data));

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ë–ï–ó –∑–∞–∫—Ä—ã—Ç–∏—è
  APP.reportItems = [];
  APP.selectedProject = null;
  document.querySelectorAll('.proj-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('selectedProjectsWrap').style.display = 'none';
  document.getElementById('commentWrap').style.display = 'none';
  document.getElementById('summary').style.display = 'none';
  document.getElementById('comment').value = '';
  document.getElementById('selectedProjectsList').innerHTML = '';
  document.getElementById('submitBtn').style.display = 'none';

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ä–∞–∑—É (–Ω–µ –∂–¥—ë–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ /start)
  data.projects.forEach(item => {
    APP.userStats = APP.userStats || { total_hours: 0, total_reports: 0, by_project: {} };
    APP.userStats.total_hours = (APP.userStats.total_hours || 0) + item.hours;
    APP.userStats.total_reports = (APP.userStats.total_reports || 0) + 1;
    APP.userStats.by_project = APP.userStats.by_project || {};
    APP.userStats.by_project[item.project] = (APP.userStats.by_project[item.project] || 0) + item.hours;
  });
  renderMyStats();

  showToast('‚úÖ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
  if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

  setTimeout(() => nav('home'), 1500);
}

// ‚îÄ‚îÄ ADD PROJECT FORM ‚îÄ‚îÄ
function initAddProjectForm() {
  document.getElementById('newAbbr').addEventListener('input', e => {
    e.target.value = e.target.value.toUpperCase();
    updateProjPreview();
  });
  document.getElementById('newFull').addEventListener('input', updateProjPreview);
}

function updateProjPreview() {
  const a = document.getElementById('newAbbr').value.trim();
  const f = document.getElementById('newFull').value.trim();
  const preview = document.getElementById('projPreview');
  if (a || f) {
    preview.style.display = 'block';
    document.getElementById('previewAbbr').textContent = a || '–ê–ë–í';
    document.getElementById('previewFull').textContent = f || '–ù–∞–∑–≤–∞–Ω–∏–µ';
  } else {
    preview.style.display = 'none';
  }
}

function submitAddProject() {
  const abbr = document.getElementById('newAbbr').value.trim().toUpperCase();
  const full = document.getElementById('newFull').value.trim();
  let ok = true;

  if (abbr.length < 2) {
    document.getElementById('abbrErr').textContent = '–ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';
    document.getElementById('abbrErr').classList.add('show'); ok = false;
  } else document.getElementById('abbrErr').classList.remove('show');

  if (full.length < 3) {
    document.getElementById('fullErr').textContent = '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
    document.getElementById('fullErr').classList.add('show'); ok = false;
  } else document.getElementById('fullErr').classList.remove('show');

  if (APP.allProjects.find(p => p.abbr === abbr)) {
    document.getElementById('abbrErr').textContent = '–ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
    document.getElementById('abbrErr').classList.add('show'); ok = false;
  }

  if (!ok) { if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); return; }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É –ë–ï–ó –∑–∞–∫—Ä—ã—Ç–∏—è (sendData –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –Ω–µ –≤—ã–∑–≤–∞–Ω tg.close)
  tg.sendData(JSON.stringify({ type: 'add_project', abbr, full }));

  // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
  const newProj = { abbr, full };
  APP.allProjects.push(newProj);
  APP.projects.push(newProj);

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
  document.getElementById('newAbbr').value = '';
  document.getElementById('newFull').value = '';
  document.getElementById('projPreview').style.display = 'none';
  document.getElementById('abbrErr').classList.remove('show');
  document.getElementById('fullErr').classList.remove('show');

  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  buildProjectsGrid();
  renderAdminManage();

  showToast(`‚úÖ –ü—Ä–æ–µ–∫—Ç ${abbr} –¥–æ–±–∞–≤–ª–µ–Ω!`);
  if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  closeModal();
}

// ‚îÄ‚îÄ MY STATS ‚îÄ‚îÄ
function renderMyStats() {
  const content = document.getElementById('myStatsContent');
  const s = APP.userStats;
  if (!s || !s.total_reports) {
    document.getElementById('myStatsSubtitle').textContent = '–ï—â—ë –Ω–µ—Ç –æ—Ç—á—ë—Ç–æ–≤';
    content.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><div>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –æ—Ç—á—ë—Ç!</div></div>`;
    return;
  }
  document.getElementById('myStatsSubtitle').textContent = `–í—Å–µ–≥–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è`;
  let html = `
    <div class="card"><div class="card-row"><div class="card-label">‚è±Ô∏è –í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="card-value">${s.total_hours}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üìù –û—Ç—á—ë—Ç–æ–≤</div><div class="card-value">${s.total_reports}</div></div></div>
    <div class="form-label" style="margin-top:4px">üìÅ –ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º</div>
  `;
  Object.entries(s.by_project || {}).sort((a,b)=>b[1]-a[1]).forEach(([proj, h]) => {
    html += `<div class="card"><div class="card-row"><span>${proj}</span><span style="font-weight:700;color:var(--accent)">${h} —á</span></div></div>`;
  });
  content.innerHTML = html;
}

// ‚îÄ‚îÄ ADMIN TABS ‚îÄ‚îÄ
let currentAdminTab = 'overview';
function adminTab(tab, btn) {
  document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentAdminTab = tab;
  renderAdminTab(tab);
}

function renderAdminTab(tab) {
  if (tab === 'overview') renderAdminOverview();
  else if (tab === 'employees') renderAdminEmployees();
  else if (tab === 'projects-stat') renderAdminProjects();
  else if (tab === 'reports-list') renderAdminReports();
  else if (tab === 'manage') renderAdminManage();
}

function renderAdminOverview() {
  if (!document.getElementById('admin-panel').classList.contains('active') && currentAdminTab !== 'overview') return;
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`;
    return;
  }
  content.innerHTML = `
    <div class="card"><div class="card-row"><div class="card-label">‚è±Ô∏è –í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="card-value">${s.total_hours}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üìù –û—Ç—á—ë—Ç–æ–≤</div><div class="card-value">${s.total_reports}</div></div></div>
    <div class="card"><div class="card-row"><div class="card-label">üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div><div class="card-value">${s.employees?.length||0}</div></div></div>
    <div class="chart-wrap"><canvas id="overviewChart"></canvas></div>
  `;
  if (s.employees?.length && typeof Chart !== 'undefined') {
    if (APP.adminChart) APP.adminChart.destroy();
    const ctx = document.getElementById('overviewChart');
    APP.adminChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: s.employees.map(e=>e.name),
        datasets: [{ label:'–ß–∞—Å—ã', data: s.employees.map(e=>e.hours), backgroundColor: 'rgba(37,99,235,0.7)', borderRadius: 6 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }
}

function renderAdminEmployees() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.employees?.length) { content.innerHTML = `<div class="empty"><div class="empty-icon">üë•</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`; return; }
  content.innerHTML = [...s.employees].sort((a,b)=>b.hours-a.hours).map(emp => `
    <div class="emp-card">
      <div class="emp-header">
        <div class="emp-name">üë§ ${emp.name}</div>
        <div class="emp-hours">${emp.hours} —á</div>
      </div>
      <div style="font-size:13px;color:var(--hint);margin-bottom:8px">üìù –û—Ç—á—ë—Ç–æ–≤: ${emp.reports}</div>
      ${Object.entries(emp.projects||{}).map(([p,h])=>`<div class="emp-proj"><span class="emp-proj-name">${p}</span><span>${h} —á</span></div>`).join('')}
    </div>
  `).join('');
}

function renderAdminProjects() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.projects) { content.innerHTML = `<div class="empty"><div class="empty-icon">üìÅ</div><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`; return; }
  const sorted = Object.entries(s.projects).sort((a,b)=>b[1]-a[1]);
  content.innerHTML = sorted.map(([p,h])=>`<div class="card"><div class="card-row"><span>${p}</span><span style="font-weight:700;color:var(--accent)">${h} —á</span></div></div>`).join('')
    + `<div class="chart-wrap"><canvas id="projChart"></canvas></div>`;
  if (sorted.length && typeof Chart !== 'undefined') {
    if (APP.projChart) APP.projChart.destroy();
    APP.projChart = new Chart(document.getElementById('projChart'), {
      type: 'doughnut',
      data: {
        labels: sorted.map(([p])=>p),
        datasets: [{ data: sorted.map(([,h])=>h), backgroundColor: ['#2563eb','#16a34a','#d97706','#9333ea','#ef4444','#0891b2'], borderWidth:0 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{font:{size:12}}}} }
    });
  }
}

function renderAdminReports() {
  const s = APP.adminStats;
  const content = document.getElementById('adminContent');
  if (!s?.recent_reports?.length) { content.innerHTML = `<div class="empty"><div class="empty-icon">üìù</div><div>–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</div></div>`; return; }
  content.innerHTML = s.recent_reports.map(r=>`
    <div class="report-item">
      <div class="report-header">
        <span class="report-emp">üë§ ${r.employee}</span>
        <span class="report-date">${r.date} ${r.time}</span>
      </div>
      <div class="report-proj">üìÅ ${r.project} ‚Äî ${r.hours} —á</div>
      ${r.comment && r.comment !== '-' ? `<div class="report-comment">üí¨ ${r.comment}</div>` : ''}
    </div>
  `).join('');
}

function renderAdminManage() {
  const content = document.getElementById('adminContent');
  const projs = APP.allProjects;
  const users = APP.allUsers;

  content.innerHTML = `
    <div class="form-label">üìÅ –ü—Ä–æ–µ–∫—Ç—ã (${projs.length})</div>
    ${projs.map(p=>`
      <div class="project-list-item">
        <span class="proj-list-name">${p.abbr} ‚Äî ${p.full}</span>
        <button class="remove-btn" onclick="removeProject('${p.abbr}')">‚úï</button>
      </div>`).join('')}
    <button class="btn btn-primary" onclick="openModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>

    <div class="form-label" style="margin-top:24px">üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</div>
    <select class="user-select" id="assignUser" onchange="renderAssignProjects()">
      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>
      ${users.map(u=>`<option value="${u.id}">${u.username}</option>`).join('')}
    </select>
    <div id="assignProjectsList" class="checkbox-list"></div>
    <button class="btn btn-primary" id="assignBtn" style="display:none" onclick="submitAssign()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</button>
  `;
}

function removeProject(abbr) {
  showConfirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç ${abbr}?`, () => {
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É ‚Äî –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    APP.allProjects = APP.allProjects.filter(p => p.abbr !== abbr);
    APP.projects = APP.projects.filter(p => p.abbr !== abbr);
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º sendData
    APP.pendingActions = APP.pendingActions || [];
    APP.pendingActions.push({ type: 'remove_project', abbr });
    buildProjectsGrid();
    renderAdminManage();
    showToast(`üóë –ü—Ä–æ–µ–∫—Ç ${abbr} —É–¥–∞–ª—ë–Ω`, 'error');
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
  });
}

function renderAssignProjects() {
  const uid = document.getElementById('assignUser').value;
  if (!uid) return;
  const list = document.getElementById('assignProjectsList');
  list.innerHTML = APP.allProjects.map(p => `
    <label class="checkbox-item">
      <input type="checkbox" value="${p.abbr}" checked>
      <span>${p.abbr} ‚Äî ${p.full}</span>
    </label>
  `).join('');
  document.getElementById('assignBtn').style.display = 'block';
}

function submitAssign() {
  const uid = parseInt(document.getElementById('assignUser').value);
  if (!uid) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error'); return; }
  const uname = APP.allUsers.find(u=>u.id===uid)?.username || '';
  const checked = [...document.querySelectorAll('#assignProjectsList input:checked')].map(c=>c.value);
  if (!checked.length) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç', 'error'); return; }
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å pendingActions (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
  APP.pendingActions = APP.pendingActions || [];
  APP.pendingActions.push({ type: 'assign_projects', user_id: uid, username: uname, abbrs: checked });

  // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤ pendingActions ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –±–æ—Ç—É –≤–º–µ—Å—Ç–µ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –æ—Ç—á—ë—Ç–æ–º
  showToast(`‚úÖ –ü—Ä–æ–µ–∫—Ç—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è ${uname}`, 'success');
  if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
  document.getElementById('assignUser').value = '';
  document.getElementById('assignProjectsList').innerHTML = '';
  document.getElementById('assignBtn').style.display = 'none';
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal() {
  document.getElementById('newAbbr').value = '';
  document.getElementById('newFull').value = '';
  document.getElementById('projPreview').style.display = 'none';
  document.getElementById('abbrErr').classList.remove('show');
  document.getElementById('fullErr').classList.remove('show');
  document.getElementById('addProjModal').classList.add('open');
}

function closeModal() {
  document.getElementById('addProjModal').classList.remove('open');
}

// –ó–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
document.getElementById('addProjModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
init();
</script>
</body>
</html>
